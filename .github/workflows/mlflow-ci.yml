name: CI Pipeline - MLflow Boston Housing

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

env:
  MLFLOW_TRACKING_URI: https://dagshub.com/rezahmas/boston-housing-mlflow.mlflow
  MLFLOW_TRACKING_USERNAME: rezahmas
  MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_TOKEN }}
  DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
  # FIX: Pastikan nama image huruf kecil semua untuk kompatibilitas Docker
  IMAGE_NAME: boston-model 

jobs:
  build-train-docker:
    runs-on: ubuntu-latest
    
    steps:
      # ==================== SETUP ====================
      - name: üì• Checkout repository
        uses: actions/checkout@v3

      - name: üêç Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12" # Versi minor (3.12.7) kadang spesifik, 3.12 lebih aman
          cache: 'pip'

      # ==================== DEPENDENCIES ====================
      - name: üì¶ Install dependencies
        run: |
          echo "Installing Python dependencies..."
          pip install --upgrade pip
          # Menginstall requirements project
          pip install -r Workflow-CI/MLProject/requirements.txt
          # FIX: Install library tambahan yang dipakai di script verifikasi (inline script) di bawah
          pip install pandas requests jq
          echo "‚úì Dependencies installed"

      # ==================== DATASET VERIFICATION ====================
      - name: ‚úÖ Verify clean dataset exists
        run: |
          cd Workflow-CI/MLProject
          
          if [ -f "HousingData_clean.csv" ]; then
            echo "‚úì HousingData_clean.csv FOUND"
            
            # Script Python untuk cek null value
            python3 << 'EOF'
          import pandas as pd
          import sys
          try:
              df = pd.read_csv('HousingData_clean.csv')
              if df.empty:
                  print("‚ùå Dataset empty!")
                  sys.exit(1)
              missing = df.isnull().sum().sum()
              if missing > 0:
                  print(f"‚ùå Dataset contains {missing} missing values!")
                  sys.exit(1)
              print("‚úì Dataset quality check passed")
          except Exception as e:
              print(f"‚ùå Error checking dataset: {e}")
              sys.exit(1)
          EOF
          else
            echo "‚ùå ERROR: HousingData_clean.csv NOT FOUND!"
            echo "Pastikan Anda sudah menjalankan preprocessing dan push hasilnya ke repo,"
            echo "ATAU tambahkan step preprocessing di workflow ini sebelum step training."
            exit 1
          fi

      # ==================== MODEL TRAINING ====================
      - name: üöÄ Train models with MLflow
        run: |
          cd Workflow-CI/MLProject
          
          # MLflow run akan mewarisi environment variables (URI, User, Password) dari level 'env' di atas
          mlflow run . \
            --env-manager=local \
            --experiment-name "CI_Docker_Build"
          
      # ==================== MLFLOW RUN MANAGEMENT ====================
      - name: üîç Get latest MLflow run ID
        id: get_run_id
        run: |
          # Tunggu sebentar agar DagsHub API sinkron (opsional tapi disarankan)
          sleep 5 
          
          EXPERIMENT_NAME="CI_Docker_Build"
          
          # Ambil Exp ID
          EXPERIMENT_ID=$(mlflow experiments search \
            --filter-string "name='$EXPERIMENT_NAME'" \
            --output json | jq -r '.[0].experiment_id')
            
          echo "Experiment ID: $EXPERIMENT_ID"
          
          # Ambil Last Run ID yang statusnya FINISHED
          LAST_RUN_ID=$(mlflow runs list \
            --experiment-id "$EXPERIMENT_ID" \
            --filter-string "status='FINISHED'" \
            --max-results 1 \
            --output json | jq -r '.[0].run_id')
            
          if [ -z "$LAST_RUN_ID" ] || [ "$LAST_RUN_ID" = "null" ]; then
             echo "‚ùå Could not find a FINISHED run id"
             exit 1
          fi
          
          echo "RUN_ID=$LAST_RUN_ID" >> $GITHUB_ENV
          echo "‚úì Locked on Run ID: $LAST_RUN_ID"

      # ==================== DOCKER BUILD ====================
      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üèóÔ∏è Build Docker image from MLflow model
        # NOTE: Step ini sering gagal jika folder 'artifacts/model' tidak standar.
        # Pastikan di modelling.py Anda log model dengan nama "model" -> mlflow.sklearn.log_model(..., "model")
        run: |
          mlflow models build-docker \
            --model-uri "runs:/${{ env.RUN_ID }}/model" \
            --name "${{ env.DOCKER_USER }}/${{ env.IMAGE_NAME }}:latest"

      # ==================== TEST CONTAINER ====================
      - name: üß™ Test Docker image
        run: |
          # Jalankan container
          docker run -d -p 8080:8080 --name test-container ${{ env.DOCKER_USER }}/${{ env.IMAGE_NAME }}:latest
          
          echo "Waiting for container initialization..."
          sleep 10
          
          # 1. Health Check
          if curl -f http://localhost:8080/ping; then
             echo "‚úì Ping check passed"
          else
             echo "‚ùå Ping check failed"
             docker logs test-container
             exit 1
          fi

          # 2. Prediction Check (Format JSON Split yang umum di MLflow)
          # Pastikan struktur data ini sesuai dengan jumlah kolom di dataset training Anda
          RESPONSE=$(curl -X POST http://localhost:8080/invocations \
            -H "Content-Type: application/json" \
            -d '{"dataframe_split": {
                "columns": ["CRIM","ZN","INDUS","CHAS","NOX","RM","AGE","DIS","RAD","TAX","PTRATIO","B","LSTAT"], 
                "data": [[0.00632,18.0,2.31,0.0,0.538,6.575,65.2,4.09,1.0,296.0,15.3,396.9,4.98]]
            }}')
          
          echo "Response: $RESPONSE"
          
          # Validasi sederhana: Cek apakah response mengandung bracket kurung siku (array hasil prediksi)
          if [[ "$RESPONSE" == *"["* ]]; then
             echo "‚úì Prediction test passed"
          else
             echo "‚ùå Prediction test failed (Invalid response)"
             exit 1
          fi
          
          docker rm -f test-container

      # ==================== DOCKER REGISTRY ====================
      - name: üîê Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: üì§ Push Docker image
        run: |
          docker push ${{ env.DOCKER_USER }}/${{ env.IMAGE_NAME }}:latest