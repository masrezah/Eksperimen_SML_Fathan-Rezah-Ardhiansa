name: CI Pipeline - MLflow Boston Housing

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

env:
  MLFLOW_TRACKING_URI: https://dagshub.com/rezahmas/boston-housing-mlflow.mlflow
  MLFLOW_TRACKING_USERNAME: rezahmas
  MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_TOKEN }}
  MLFLOW_EXPERIMENT_NAME: CI_Docker_Build
  DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
  IMAGE_NAME: boston-model

jobs:
  build-train-docker:
    runs-on: ubuntu-latest
    
    steps:
      # ==================== SETUP ====================
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üêç Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      # ==================== DEPENDENCIES ====================
      - name: üì¶ Install dependencies
        run: |
          echo "Installing Python dependencies..."
          pip install --upgrade pip
          pip install -r Workflow-CI/MLProject/requirements.txt
          # Install library tambahan untuk script verifikasi di bawah
          pip install pandas requests
          echo "‚úì Dependencies installed"

      # ==================== DATASET VERIFICATION ====================
      - name: ‚úÖ Verify clean dataset exists
        run: |
          cd Workflow-CI/MLProject
          if [ -f "HousingData_clean.csv" ]; then
            echo "‚úì HousingData_clean.csv FOUND"
            python3 << 'EOF'
          import pandas as pd
          import sys

          try:
              df = pd.read_csv('HousingData_clean.csv')
              if df.empty:
                  print("‚ùå Dataset is empty!")
                  sys.exit(1)
              
              missing = df.isnull().sum().sum()
              if missing > 0:
                  print(f"‚ùå Dataset contains {missing} missing values!")
                  sys.exit(1)
              
              if "MEDV" not in df.columns:
                  print("‚ùå Target column 'MEDV' not found!")
                  sys.exit(1)
              
              print(f"‚úì Dataset quality check passed")
              print(f"  - Shape: {df.shape}")
              print(f"  - Columns: {len(df.columns)}")
          except Exception as e:
              print(f"‚ùå Error checking dataset: {e}")
              sys.exit(1)
          EOF
          else
            echo "‚ùå ERROR: HousingData_clean.csv NOT FOUND!"
            echo "Make sure you have the cleaned dataset in the repository."
            exit 1
          fi

      # ==================== MODEL TRAINING ====================
      - name: üöÄ Train models with MLflow
        run: |
          cd Workflow-CI/MLProject
          echo "=========================================="
          echo "Starting MLflow training..."
          echo "=========================================="
          
          # Run training via MLflow
          mlflow run . \
            --env-manager=local \
            --experiment-name "$MLFLOW_EXPERIMENT_NAME"
          
          echo "‚úì Training completed"

      # ==================== WAIT FOR DAGSHUB SYNC ====================
      - name: ‚è≥ Wait for DagsHub synchronization
        run: |
          echo "Waiting 20 seconds for DagsHub to sync artifacts..."
          sleep 20
          echo "‚úì Sync wait completed"

      # ==================== GET MLFLOW RUN ID ====================
      - name: üîç Get best model run ID
        id: get_run_id
        run: |
          cd Workflow-CI/MLProject
          python3 << 'EOF'
          import mlflow
          from mlflow.tracking import MlflowClient
          import os
          import sys
          import time

          print("üîç SEARCHING FOR BEST MODEL RUN")
          MAX_RETRIES = 5
          RETRY_DELAY = 10

          try:
              mlflow.set_tracking_uri(os.environ['MLFLOW_TRACKING_URI'])
              client = MlflowClient()
              experiment_name = os.environ.get('MLFLOW_EXPERIMENT_NAME', 'CI_Docker_Build')
              
              experiment = mlflow.get_experiment_by_name(experiment_name)
              if experiment is None:
                  print(f"‚ùå Experiment '{experiment_name}' not found!")
                  sys.exit(1)
              
              exp_id = experiment.experiment_id
              print(f"‚úì Experiment found - ID: {exp_id}")
              
              # Cari run terakhir yang statusnya FINISHED
              runs = mlflow.search_runs(
                  experiment_ids=[exp_id],
                  filter_string="status = 'FINISHED'",
                  order_by=["start_time DESC"],
                  max_results=5
              )
              
              selected_run = None
              if not runs.empty:
                  for idx, row in runs.iterrows():
                      run_id = row.run_id
                      # Cek apakah artefak model benar-benar ada
                      artifacts = client.list_artifacts(run_id)
                      artifact_paths = [a.path for a in artifacts]
                      if "model" in artifact_paths:
                          selected_run = row
                          break
              
              if selected_run is None:
                  print("‚ùå No run with 'model' artifact found!")
                  sys.exit(1)

              run_id = selected_run.run_id
              run_name = selected_run.get('tags.mlflow.runName', 'Unknown')
              
              print(f"‚úÖ RUN SELECTED: {run_id} ({run_name})")
              
              # Export to GitHub Environment Variables
              with open(os.environ['GITHUB_ENV'], 'a') as f:
                  f.write(f"RUN_ID={run_id}\n")
                  f.write(f"RUN_NAME={run_name}\n")
              
          except Exception as e:
              print(f"‚ùå FATAL ERROR: {e}")
              sys.exit(1)
          EOF

      # ==================== DOCKER BUILD ====================
      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üèóÔ∏è Build Docker image from MLflow model
        run: |
          echo "Building Docker image from Run ID: ${{ env.RUN_ID }}"
          mlflow models build-docker \
            --model-uri "runs:/${{ env.RUN_ID }}/model" \
            --name "${{ env.DOCKER_USER }}/${{ env.IMAGE_NAME }}:latest"

      # ==================== TEST CONTAINER ====================
      - name: üß™ Test Docker container
        run: |
          echo "Starting container..."
          docker run -d -p 8080:8080 --name test-container \
            ${{ env.DOCKER_USER }}/${{ env.IMAGE_NAME }}:latest
          
          echo "Waiting for container initialization (20s)..."
          sleep 20
          
          # Test 1: Health Check
          if curl -f http://localhost:8080/ping; then
             echo "‚úì Health check passed"
          else
             echo "‚ùå Health check failed"
             docker logs test-container
             exit 1
          fi

          # Test 2: Prediction
          echo "Testing prediction endpoint..."
          RESPONSE=$(curl -X POST http://localhost:8080/invocations \
            -H "Content-Type: application/json" \
            -d '{"dataframe_split": {"columns": ["CRIM","ZN","INDUS","CHAS","NOX","RM","AGE","DIS","RAD","TAX","PTRATIO","B","LSTAT"], "data": [[0.00632,18.0,2.31,0.0,0.538,6.575,65.2,4.09,1.0,296.0,15.3,396.9,4.98]]}}')
          
          if [[ "$RESPONSE" == *"["* ]]; then
             echo "‚úì Prediction test passed: $RESPONSE"
          else
             echo "‚ùå Prediction failed"
             exit 1
          fi
          
          docker rm -f test-container

      # ==================== DOCKER LOGIN & PUSH ====================
      - name: üîê Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: üì§ Push Docker image
        run: |
          docker push ${{ env.DOCKER_USER }}/${{ env.IMAGE_NAME }}:latest

      # ==================== SUMMARY ====================
      - name: üìä Pipeline Summary
        if: always()
        run: |
          echo "Pipeline Completed!"
          echo "Docker Image: ${{ env.DOCKER_USER }}/${{ env.IMAGE_NAME }}:latest"
          echo "MLflow Run: ${{ env.RUN_ID }}"