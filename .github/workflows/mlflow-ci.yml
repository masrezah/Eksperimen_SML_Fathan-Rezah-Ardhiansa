name: CI Pipeline - Google Drive & Docker

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

env:
  # Kita tidak pakai env global untuk user, tapi kita ambil langsung di step agar bisa dibersihkan
  IMAGE_NAME: boston-model
  MLFLOW_TRACKING_URI: ""

jobs:
  build-train-drive-docker:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Set up job & Checkout
      - uses: actions/checkout@v3

      # 2. Set up Python
      - name: Set up Python 3.12.7
        uses: actions/setup-python@v4
        with:
          python-version: "3.12.7"
          cache: 'pip'

      # 3. Check Env
      - name: Check Env
        run: |
          echo "Checking Environment..."
          python --version
          pip --version

      # 4. Install dependencies
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install pandas scikit-learn mlflow
          if [ -f "Workflow-CI/MLProject/requirements.txt" ]; then
            pip install -r Workflow-CI/MLProject/requirements.txt
          fi

      # 5. Run mlflow project
      - name: Run mlflow project
        run: |
          cd Workflow-CI/MLProject
          mlflow run . --env-manager=local --experiment-name "CI_Drive_Build"

      # 6. Get latest MLflow run_id
      - name: Get latest MLflow run_id
        id: get_run_id
        run: |
          cd Workflow-CI/MLProject
          python3 << 'EOF'
          import mlflow
          import os
          
          mlflow.set_tracking_uri("sqlite:///mlflow.db")
          
          try:
              current_exp = mlflow.get_experiment_by_name("CI_Drive_Build")
              runs = mlflow.search_runs(
                  [current_exp.experiment_id], 
                  order_by=["start_time DESC"], 
                  max_results=1
              )
              
              if runs.empty:
                  print("❌ No runs found!")
                  exit(1)

              run_id = runs.iloc[0].run_id
              print(f"Found Run ID: {run_id}")
              
              with open(os.environ['GITHUB_ENV'], 'a') as f:
                  f.write(f"RUN_ID={run_id}\n")
          except Exception as e:
              print(f"❌ Error finding run: {e}")
              exit(1)
          EOF

      # 7. Install Python dependencies (Drive)
      - name: Install Python dependencies
        run: |
          pip install PyDrive2 google-api-python-client oauth2client

      # 8. Upload to Google Drive (Dummy)
      - name: Upload to Google Drive
        run: |
          echo "Simulating upload to Google Drive..."
          echo "Uploading artifacts from Run ID: ${{ env.RUN_ID }}"

      # 9. Build Docker Model (FIXED: Cleaning Username)
      - name: Build Docker Model
        env:
          RAW_USER: ${{ secrets.DOCKER_USERNAME }}
        run: |
          cd Workflow-CI/MLProject
          
          # FIX: Hapus spasi/enter dari username
          CLEAN_USER=$(echo "$RAW_USER" | tr -d '\n' | tr -d '\r' | xargs)
          echo "Building for user: $CLEAN_USER"
          
          export MLFLOW_TRACKING_URI="sqlite:///mlflow.db"
          
          mlflow models build-docker \
            --model-uri "runs:/${{ env.RUN_ID }}/model" \
            --name "${CLEAN_USER}/${{ env.IMAGE_NAME }}:latest"

      # 10. Log in to Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 11. Tag Docker Image
      - name: Tag Docker Image
        env:
          RAW_USER: ${{ secrets.DOCKER_USERNAME }}
        run: |
          CLEAN_USER=$(echo "$RAW_USER" | tr -d '\n' | tr -d '\r' | xargs)
          
          docker tag ${CLEAN_USER}/${{ env.IMAGE_NAME }}:latest ${CLEAN_USER}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      # 12. Push Docker Image
      - name: Push Docker Image
        env:
          RAW_USER: ${{ secrets.DOCKER_USERNAME }}
        run: |
          CLEAN_USER=$(echo "$RAW_USER" | tr -d '\n' | tr -d '\r' | xargs)
          
          docker push ${CLEAN_USER}/${{ env.IMAGE_NAME }}:latest
          docker push ${CLEAN_USER}/${{ env.IMAGE_NAME }}:${{ github.sha }}