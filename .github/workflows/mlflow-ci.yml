name: CI Pipeline - MLflow Boston Housing

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

env:
  MLFLOW_TRACKING_URI: https://dagshub.com/rezahmas/boston-housing-mlflow.mlflow
  MLFLOW_TRACKING_USERNAME: rezahmas
  MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_TOKEN }}
  MLFLOW_EXPERIMENT_NAME: CI_Docker_Build
  DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
  IMAGE_NAME: boston-model

jobs:
  build-train-docker:
    runs-on: ubuntu-latest
    
    steps:
      # ==================== 1. SETUP & CHECKOUT ====================
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üêç Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      # ==================== 2. INSTALL DEPENDENCIES ====================
      - name: üì¶ Install dependencies
        run: |
          echo "Installing Python dependencies..."
          pip install --upgrade pip
          
          # Install requirements dari project
          if [ -f "Workflow-CI/MLProject/requirements.txt" ]; then
            pip install -r Workflow-CI/MLProject/requirements.txt
          fi
          
          # FIX PENTING: Install library wajib untuk upload ke DagsHub & S3
          pip install pandas requests boto3 dagshub mlflow scikit-learn
          
          echo "‚úì Dependencies installed"

      # ==================== 3. VERIFY DATASET ====================
      - name: ‚úÖ Verify clean dataset exists
        run: |
          if [ ! -f "Workflow-CI/MLProject/HousingData_clean.csv" ]; then
            echo "‚ùå ERROR: File HousingData_clean.csv tidak ditemukan di Workflow-CI/MLProject/"
            exit 1
          fi
          echo "‚úì Dataset found."

      # ==================== 4. TRAINING & UPLOAD ====================
      - name: üöÄ Train models & Upload to DagsHub
        run: |
          cd Workflow-CI/MLProject
          
          # Jalankan script python langsung agar environment variabel terbaca sempurna
          python modelling.py

      # ==================== 5. WAIT FOR SYNC ====================
      - name: ‚è≥ Wait for DagsHub S3 sync
        run: |
          echo "Waiting 15 seconds for artifacts to appear in S3..."
          sleep 15

      # ==================== 6. GET RUN ID & VERIFY ARTIFACT ====================
      - name: üîç Get Run ID & Verify 'model' folder
        id: get_run_id
        run: |
          cd Workflow-CI/MLProject
          python3 << 'EOF'
          import mlflow
          from mlflow.tracking import MlflowClient
          import os
          import sys

          try:
              # Setup
              mlflow.set_tracking_uri(os.environ['MLFLOW_TRACKING_URI'])
              client = MlflowClient()
              exp_name = os.environ['MLFLOW_EXPERIMENT_NAME']
              
              print(f"üîç Searching for experiment: {exp_name}")
              experiment = mlflow.get_experiment_by_name(exp_name)
              
              if not experiment:
                  print("‚ùå Experiment not found")
                  sys.exit(1)
              
              # Cari Run Terakhir yang FINISHED
              runs = mlflow.search_runs(
                  [experiment.experiment_id], 
                  filter_string="status='FINISHED'", 
                  order_by=["start_time DESC"], 
                  max_results=1
              )
              
              if runs.empty:
                  print("‚ùå No FINISHED runs found")
                  sys.exit(1)
                  
              run_id = runs.iloc[0].run_id
              print(f"üÜî Checking Run ID: {run_id}")
              
              # Cek Isi Artefak
              artifacts = client.list_artifacts(run_id)
              paths = [a.path for a in artifacts]
              print(f"üìÇ Artifacts found: {paths}")
              
              if "model" not in paths:
                  print(f"‚ùå CRITICAL ERROR: Folder 'model' tidak ditemukan!")
                  print("   Pastikan modelling.py menggunakan artifact_path='model'")
                  print("   dan library 'boto3' terinstall.")
                  sys.exit(1)
                  
              print("‚úÖ 'model' artifact verified successfully")
              
              # Simpan Run ID ke GitHub Env
              with open(os.environ['GITHUB_ENV'], 'a') as f:
                  f.write(f"RUN_ID={run_id}\n")

          except Exception as e:
              print(f"‚ùå Fatal Error: {e}")
              sys.exit(1)
          EOF

      # ==================== 7. BUILD DOCKER IMAGE ====================
      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üèóÔ∏è Build Docker image
        run: |
          echo "Building Docker image from Run ID: ${{ env.RUN_ID }}"
          
          mlflow models build-docker \
            --model-uri "runs:/${{ env.RUN_ID }}/model" \
            --name "${{ env.DOCKER_USER }}/${{ env.IMAGE_NAME }}:latest"

      # ==================== 8. TEST CONTAINER ====================
      - name: üß™ Test Docker container
        run: |
          echo "Starting container for testing..."
          docker run -d -p 8080:8080 --name test-container ${{ env.DOCKER_USER }}/${{ env.IMAGE_NAME }}:latest
          
          echo "Waiting 15s for container initialization..."
          sleep 15
          
          # Health Check
          echo "Testing Health (/ping)..."
          if ! curl -f http://localhost:8080/ping; then
             echo "‚ùå Health check failed!"
             docker logs test-container
             exit 1
          fi
          echo "‚úì Health check passed"
          
          # Prediction Check
          echo "Testing Prediction (/invocations)..."
          RESPONSE=$(curl -X POST http://localhost:8080/invocations \
            -H "Content-Type: application/json" \
            -d '{"dataframe_split": {"columns": ["CRIM","ZN","INDUS","CHAS","NOX","RM","AGE","DIS","RAD","TAX","PTRATIO","B","LSTAT"], "data": [[0.00632,18.0,2.31,0.0,0.538,6.575,65.2,4.09,1.0,296.0,15.3,396.9,4.98]]}}')
          
          if [[ "$RESPONSE" == *"["* ]]; then
             echo "‚úì Prediction test passed"
          else
             echo "‚ùå Prediction failed or unexpected response: $RESPONSE"
             exit 1
          fi

          docker rm -f test-container

      # ==================== 9. PUSH TO REGISTRY ====================
      - name: üîê Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: üì§ Push Docker image
        run: |
          docker push ${{ env.DOCKER_USER }}/${{ env.IMAGE_NAME }}:latest