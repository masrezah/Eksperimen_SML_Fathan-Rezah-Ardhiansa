name: CI Pipeline - MLflow Boston Housing

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

env:
  MLFLOW_TRACKING_URI: https://dagshub.com/rezahmas/boston-housing-mlflow.mlflow
  MLFLOW_TRACKING_USERNAME: rezahmas
  MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_TOKEN }}
  MLFLOW_EXPERIMENT_NAME: CI_Docker_Build
  DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
  IMAGE_NAME: boston-model

jobs:
  build-train-docker:
    runs-on: ubuntu-latest
    
    steps:
      # 1. SETUP
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üêç Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      # 2. DEPENDENCIES
      - name: üì¶ Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r Workflow-CI/MLProject/requirements.txt
          pip install pandas requests

      # 3. VERIFY DATASET
      - name: ‚úÖ Verify clean dataset exists
        run: |
          cd Workflow-CI/MLProject
          if [ ! -f "HousingData_clean.csv" ]; then
            echo "‚ùå ERROR: HousingData_clean.csv NOT FOUND!"
            exit 1
          fi
          echo "‚úì Dataset found."

      # 4. TRAINING
      - name: üöÄ Train models with MLflow
        run: |
          cd Workflow-CI/MLProject
          mlflow run . --env-manager=local --experiment-name "$MLFLOW_EXPERIMENT_NAME"

      # 5. WAIT SYNC
      - name: ‚è≥ Wait for DagsHub sync
        run: sleep 15

      # 6. GET RUN ID (Script Python Sederhana)
      - name: üîç Get Run ID & Verify Artifact
        id: get_run_id
        run: |
          cd Workflow-CI/MLProject
          python3 << 'EOF'
          import mlflow
          from mlflow.tracking import MlflowClient
          import os
          import sys

          try:
              # Setup
              mlflow.set_tracking_uri(os.environ['MLFLOW_TRACKING_URI'])
              client = MlflowClient()
              exp_name = os.environ['MLFLOW_EXPERIMENT_NAME']
              
              # Get Experiment
              experiment = mlflow.get_experiment_by_name(exp_name)
              if not experiment:
                  print("‚ùå Experiment not found")
                  sys.exit(1)
              
              # Get Last Run
              runs = mlflow.search_runs(
                  [experiment.experiment_id], 
                  filter_string="status='FINISHED'", 
                  order_by=["start_time DESC"], 
                  max_results=1
              )
              
              if runs.empty:
                  print("‚ùå No FINISHED runs found")
                  sys.exit(1)
                  
              run_id = runs.iloc[0].run_id
              print(f"Checking Run ID: {run_id}")
              
              # Verify 'model' folder exists
              artifacts = client.list_artifacts(run_id)
              paths = [a.path for a in artifacts]
              
              if "model" not in paths:
                  print(f"‚ùå Error: 'model' folder not found in artifacts! Found: {paths}")
                  sys.exit(1)
                  
              print("‚úì 'model' artifact found successfully")
              
              # Save to Env for Next Step
              with open(os.environ['GITHUB_ENV'], 'a') as f:
                  f.write(f"RUN_ID={run_id}\n")

          except Exception as e:
              print(f"‚ùå Fatal Error: {e}")
              sys.exit(1)
          EOF

      # 7. BUILD DOCKER
      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üèóÔ∏è Build Docker image
        run: |
          echo "Building from Run ID: ${{ env.RUN_ID }}"
          mlflow models build-docker \
            --model-uri "runs:/${{ env.RUN_ID }}/model" \
            --name "${{ env.DOCKER_USER }}/${{ env.IMAGE_NAME }}:latest"

      # 8. TEST CONTAINER
      - name: üß™ Test Docker container
        run: |
          docker run -d -p 8080:8080 --name test-container ${{ env.DOCKER_USER }}/${{ env.IMAGE_NAME }}:latest
          sleep 15
          
          # Health Check
          if ! curl -f http://localhost:8080/ping; then
             docker logs test-container
             exit 1
          fi
          
          # Prediction Check
          curl -X POST http://localhost:8080/invocations \
            -H "Content-Type: application/json" \
            -d '{"dataframe_split": {"columns": ["CRIM","ZN","INDUS","CHAS","NOX","RM","AGE","DIS","RAD","TAX","PTRATIO","B","LSTAT"], "data": [[0.00632,18.0,2.31,0.0,0.538,6.575,65.2,4.09,1.0,296.0,15.3,396.9,4.98]]}}'

          docker rm -f test-container

      # 9. PUSH
      - name: üîê Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: üì§ Push Docker image
        run: docker push ${{ env.DOCKER_USER }}/${{ env.IMAGE_NAME }}:latest